service: khanflow-backend

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'production'}
  timeout: 30
  memorySize: 1024
  environment:
    NODE_ENV: production
    PORT: 8000
    BASE_PATH: /api
    DATABASE_URL: ${env:DATABASE_URL}
    JWT_SECRET: ${env:JWT_SECRET}
    JWT_EXPIRES_IN: 7d
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID}
    GOOGLE_CLIENT_SECRET: ${env:GOOGLE_CLIENT_SECRET}
    GOOGLE_REDIRECT_URI: ${env:GOOGLE_REDIRECT_URI}
    GOOGLE_INTEGRATION_REDIRECT_URI: ${env:GOOGLE_INTEGRATION_REDIRECT_URI}
    MICROSOFT_CLIENT_ID: ${env:MICROSOFT_CLIENT_ID}
    MICROSOFT_CLIENT_SECRET: ${env:MICROSOFT_CLIENT_SECRET}
    MICROSOFT_REDIRECT_URI: ${env:MICROSOFT_REDIRECT_URI}
    ZOOM_CLIENT_ID: ${env:ZOOM_CLIENT_ID}
    ZOOM_CLIENT_SECRET: ${env:ZOOM_CLIENT_SECRET}
    ZOOM_REDIRECT_URI: ${env:ZOOM_REDIRECT_URI}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    FRONTEND_ORIGIN: ${env:FRONTEND_ORIGIN}
    FRONTEND_INTEGRATION_URL: ${env:FRONTEND_INTEGRATION_URL}
    SUPABASE_URL: ${env:SUPABASE_URL}
    SUPABASE_SERVICE_ROLE_KEY: ${env:SUPABASE_SERVICE_ROLE_KEY}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'

functions:
  api:
    handler: dist/src/lambda.handler
    events:
      - httpApi: '*'

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  dotenv:
    path: .env.deploy
  serverless-offline:
    httpPort: 8000
    host: 0.0.0.0

package:
  patterns:
    - 'dist/**'
    - '!src/**'
    - '!tests/**'
    - '!node_modules/@types/**'
    - '!node_modules/typescript/**'
    - '!node_modules/ts-node*/**'
    - '!node_modules/@typescript-eslint/**'
    - '!node_modules/eslint*/**'
    - '!node_modules/vitest/**'
    - '!node_modules/@vitest/**'
    - '!node_modules/serverless*/**'
    - '!node_modules/webpack*/**'
    - '!node_modules/ts-loader/**'
    - '!**/*.md'
    - '!**/*.d.ts'
    - '!**/*.map'
